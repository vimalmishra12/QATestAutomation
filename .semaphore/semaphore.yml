version: v1.0
name: Test Automation CI
agent:
  machine:
    type: ubuntu20
    os_image: ''
blocks:
  - name: Install Dependencies
    task:
      prologue:
        commands:
          - echo "Updating package lists"
          - sudo apt-get update
          - echo "Removing existing Chrome"
          - sudo apt-get remove -y google-chrome-stable
          - echo "Installing dependencies"
          - sudo apt-get install -y wget unzip
          - echo "Downloading and installing the required Chrome version"
          - 'CHROME_VERSION=$(jq -r ''.dependencies.chromedriver'' package.json | sed ''s/[^0-9.]*//g'')'
          - 'wget https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_${CHROME_VERSION}_amd64.deb -O google-chrome.deb'
          - sudo dpkg -i google-chrome.deb || sudo apt-get install -f -y
          - echo "Checking Chrome version"
          - google-chrome --version
          - echo "Downloading and setting up ChromeDriver"
          - 'wget https://chromedriver.storage.googleapis.com/${CHROME_VERSION}/chromedriver_linux64.zip'
          - unzip chromedriver_linux64.zip
          - sudo mv chromedriver /usr/local/bin/chromedriver
          - chromedriver --version
      epilogue:
        always:
          commands:
            - echo "Installation completed"
      jobs: []
  - name: Install Node.js Dependencies
    task:
      prologue:
        commands:
          - echo "Installing Node.js dependencies"
          - npm install
      jobs: []
  - name: Run WebDriverIO Tests
    task:
      prologue:
        commands:
          - echo "Running WebDriverIO tests"
          - npm run test
      jobs: []
  - name: Upload Test Artifacts
    task:
      prologue:
        commands:
          - echo "Uploading test artifacts"
          - tar -cvf test-results.tar test-results/
      artifacts:
        files:
          - test-results.tar
      jobs: []
