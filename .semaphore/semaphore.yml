version: v1.0
name: Update Semaphore configuration
agent:
  machine:
    type: e2-standard-2
    os_image: ubuntu2204
blocks:
  - name: C1LoginTest
    task:
      jobs:
        - name: C1LoginTest
          commands:
            - 'version: v1.0'
            - 'name: CI with Chrome and WebdriverIO'
            - 'agent:'
            - '  machine:'
            - '    type: e1-standard-2'
            - '    os_image: ubuntu20.04'
            - 'blocks:'
            - '  - name: C1LoginTest'
            - '    task:'
            - '      prologue:'
            - '        commands:'
            - '          - echo "Starting prologue commands"'
            - '          - checkout'
            - '          - sudo apt-get update'
            - '          - sudo apt-get install -y nodejs npm'
            - '          # Setting Node.js version'
            - '          - echo "Setting Node.js version"'
            - '          - sem-version node 14.21.3'
            - '          # Restore cache for faster npm installs'
            - '          - echo "Restoring npm cache"'
            - '          - cache restore'
            - '          # Install dependencies (Chrome, Chromedriver, WebdriverIO)'
            - '          - echo "Installing npm dependencies"'
            - '          - npm install'
            - '          # Store cache for future runs'
            - '          - echo "Storing npm cache"'
            - '          - cache store'
            - '      epilogue:'
            - '        always:'
            - '          commands:'
            - '            - echo "Running test script"'
            - '            - npm run loginFeatureTest'
            - '            - RESULT=$?'
            - '            - echo "Test result: $RESULT"'
            - '            - if [ $RESULT -eq 0 ]; then STATUS="passed"; else STATUS="failed"; fi'
            - '            # Verify reports'
            - '            - echo "Verifying directory structure"'
            - '            - cd /home/semaphore/QATestAutomation/testAutomation_v1.0/output/reports || { echo "Directory not found"; exit 1; }'
            - '            - ls -la'
            - '            - TIMELINE_REPORT=$(find /home/semaphore/QATestAutomation/testAutomation_v1.0/output/reports/TestReports -type f -name "*.html")'
            - '            - if [ -z "$TIMELINE_REPORT" ]; then echo "No HTML report files found"; exit 1; fi'
            - '            # Send email'
            - '            - echo "Running mailer.js with parameters"'
            - '            - cd /home/semaphore/QATestAutomation/testAutomation_v1.0/core/utils || { echo "Directory not found"; exit 1; }'
            - '            - node mailer.js --appType="ExperienceApp" \'
            - '                             --testEnv="qa" \'
            - '                             --projectName="$SEMAPHORE_PROJECT_NAME" \'
            - '                             --branchName="$SEMAPHORE_GIT_BRANCH" \'
            - '                             --buildNumber="$SEMAPHORE_WORKFLOW_NUMBER" \'
            - '                             --jobID="$SEMAPHORE_JOB_ID" \'
            - '                             --mailingList="vimal.mishra@comprotechnologies.com, vikrant.chaudhary@comprotechnologies.com" \'
            - '                             --jobResult="$STATUS" \'
            - '                             --emailId="$emailId" \'
            - '                             --emailPwd="$emailPwd" \'
            - '                             --triggerSource="Semaphore" \'
            - '                             > /home/semaphore/mailer.log 2>&1'
            - '            - cat /home/semaphore/mailer.log'
      secrets:
        - name: Cred
