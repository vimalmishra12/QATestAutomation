version: v1.0
name: Update Semaphore configuration
agent:
  machine:
    type: e2-standard-2
    os_image: ubuntu2204
blocks:
  - name: C1LoginTest
    task:
      jobs:
        - name: C1LoginTest
          commands:
            - echo "Starting setup."
            - checkout
            - sudo apt-get update && sudo apt-get install -y wget unzip
            - if command -v google-chrome; then echo "Pre-installed Chrome found. Removing..."; sudo apt-get remove -y google-chrome-stable; else echo "No pre-installed Chrome found."; fi
            - echo "Installing latest Google Chrome..."
            - 'wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -'
            - 'echo ''deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main'' | sudo tee /etc/apt/sources.list.d/google-chrome.list'
            - sudo apt-get update && sudo apt-get install -y google-chrome-stable
            - google-chrome --version
            - CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
            - echo "Detected Chrome version: $CHROME_VERSION"
            - echo "Downloading matching ChromeDriver..."
            - 'CHROMEDRIVER_VERSION=$(curl -sS https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION)'
            - 'wget https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip'
            - unzip chromedriver_linux64.zip
            - sudo mv chromedriver /usr/local/bin/
            - sudo chmod +x /usr/local/bin/chromedriver
            - chromedriver --version
            - echo "Installing Node.js..."
            - sem-version node 14.21.3
            - npm install -g npm
            - node -v
            - npm -v
            - cache restore
            - npm install
            - cache store
  - name: Run Tests
    task:
      jobs:
        - name: Run Login Test
          commands:
            - echo "Running test script..."
            - npm run loginFeatureTest
