version: v1.0
name: Update Semaphore configuration
agent:
  machine:
    type: e2-standard-2
    os_image: ubuntu2204
blocks:
  - name: C1LoginTest
    task:
      jobs:
        - name: C1LoginTest
          commands:
            - echo "Starting prologue commands"
            - checkout
            - sudo apt-get update
            - sudo apt-get remove -y google-chrome-stable
            - sudo apt-get install -y wget unzip curl
            - echo "Downloading and installing Google Chrome version 114.0.5735.90"
            - 'wget https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_114.0.5735.90-1_amd64.deb'
            - sudo dpkg -i google-chrome-stable_114.0.5735.90-1_amd64.deb || sudo apt-get install -f -y
            - sudo rm -rf /usr/local/bin/chromedriver
            - echo "Downloading and setting up ChromeDriver version 114.0.5735.90"
            - 'wget https://chromedriver.storage.googleapis.com/114.0.5735.90/chromedriver_linux64.zip'
            - unzip chromedriver_linux64.zip
            - sudo mv chromedriver /usr/local/bin/chromedriver
            - sudo chmod +x /usr/local/bin/chromedriver
            - google-chrome --version
            - chromedriver --version
            - echo "Installing Node.js and npm"
            - sudo apt-get install -y nodejs npm
            - echo "Setting Node.js version"
            - sem-version node 14.21.3
            - echo "Restoring npm cache"
            - cache restore
            - echo "Installing npm dependencies"
            - npm install
            - echo "Storing npm cache"
            - cache store
            - echo "Running test script"
            - npm run loginFeatureTest
            - |
              RESULT=$?
              echo "Test Result: $RESULT"
              if [ $RESULT -eq 0 ]; then
                STATUS="passed"
              else
                STATUS="failed"
                echo "Test failed! Collecting logs..."
                ls -la /home/semaphore/QATestAutomation/testAutomation_v1.0/output/reports
              fi
