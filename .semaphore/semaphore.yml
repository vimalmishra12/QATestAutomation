version: v1.0
name: Automation Test Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Run Automation Tests
    task:
      jobs:
        - name: Execute Tests
          commands:
            - echo "Starting prologue commands"
            - checkout
            - sudo apt-get update
            - sudo apt-get remove -y google-chrome-stable
            - sudo rm -rf /usr/local/bin/chromedriver
            - sudo rm -rf ~/.cache/google-chrome
            - sudo rm -rf ~/.config/google-chrome
            - echo "Installing Google Chrome 132"
            - 'wget -q -O google-chrome.deb https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_132.0.6261.128-1_amd64.deb'
            - sudo dpkg -i google-chrome.deb || sudo apt-get -f install -y
            - rm google-chrome.deb
            - google-chrome --version
            - echo "Installing ChromeDriver for Chrome 132"
            - 'wget -q https://chromedriver.storage.googleapis.com/132.0.6261.0/chromedriver_linux64.zip'
            - unzip chromedriver_linux64.zip
            - sudo mv chromedriver /usr/local/bin/
            - sudo chmod +x /usr/local/bin/chromedriver
            - rm chromedriver_linux64.zip
            - chromedriver --version
            - echo "Installing Node.js using nvm"
            - export NVM_DIR="$HOME/.nvm"
            - source "$NVM_DIR/nvm.sh"
            - source "$NVM_DIR/bash_completion"
            - nvm install 21.6.2
            - nvm use 21.6.2
            - node -v
            - echo "Prologue commands completed"
            - echo "Starting C1LoginTest job"
            - cd /home/semaphore/QATestAutomation/testAutomation_v1.0
            - echo "Restoring npm cache"
            - cache restore
            - echo "Installing npm dependencies"
            - npm install --legacy-peer-deps
            - echo "Storing npm cache"
            - cache store
            - echo "Running the test script with debug logging"
            - DEBUG=webdriver* npm run loginFeatureTest
            - RESULT=$?
            - echo "Test result: $RESULT"
            - '[ $RESULT -eq 0 ] && echo ''Test Status: passed'' || echo ''Test Status: failed'''
            - echo "Verifying test report files"
            - cd /home/semaphore/QATestAutomation/testAutomation_v1.0/output/reports || (echo 'Reports directory not found' && exit 1)
            - ls -la || (echo 'No reports directory found' && exit 1)
            - cd TestReports || (echo 'No TestReports directory found' && exit 1)
            - ls -la || (echo 'No files in TestReports directory' && exit 1)
            - echo "Verifying Timeline report files"
            - 'TIMELINE_REPORT=$(find /home/semaphore/QATestAutomation/testAutomation_v1.0/output/reports/TestReports -type f -name ''*.html''); [ -z "$TIMELINE_REPORT" ] && echo ''No HTML report files found'' && exit 1 || echo ''Timeline report found: $TIMELINE_REPORT'''
            - echo "Verifying log file"
            - 'LOG_FILE=''/home/semaphore/QATestAutomation/testAutomation_v1.0/output/reports/TestReports/wdio-0-0-timeline-reporter.log''; [ ! -f "$LOG_FILE" ] && echo ''Timeline log file not found'' && exit 1 || echo ''Timeline log file found: $LOG_FILE'''
